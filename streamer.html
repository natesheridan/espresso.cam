<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Streamer | Multi-Streamer Broadcast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Agora Web SDK 4.x -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.2.js"></script>
    <!-- Agora RTM SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTM-1.5.1.js"></script>
  </head>
  <body class="min-h-screen bg-gray-950 text-gray-100">
    <main class="max-w-5xl mx-auto px-4 py-10">
      <section class="text-center mb-8">
        <h1 class="text-3xl font-bold tracking-tight">Start Streaming</h1>
        <p class="text-gray-400 mt-2">
          Enter your Agora credentials to broadcast your camera and microphone.
        </p>
      </section>

      <section
        class="bg-gray-900/60 border border-gray-800 rounded-xl p-6 shadow-lg"
      >
        <div class="grid md:grid-cols-3 gap-4">
          <div class="md:col-span-1">
            <label for="appId" class="block text-sm text-gray-300">Agora App ID</label>
            <input
              id="appId"
              type="text"
              placeholder="e.g., 0123456789abcdef0123456789abcdef"
              class="mt-1 w-full rounded-md bg-gray-800 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
          </div>
          <div class="md:col-span-1">
            <label for="token" class="block text-sm text-gray-300">Agora Token (optional)</label>
            <input
              id="token"
              type="text"
              placeholder="Leave blank if token is not required"
              class="mt-1 w-full rounded-md bg-gray-800 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
          </div>
          <div class="md:col-span-1">
            <label for="channel" class="block text-sm text-gray-300">Channel Name</label>
            <input
              id="channel"
              type="text"
              placeholder="e.g., my-shared-room"
              class="mt-1 w-full rounded-md bg-gray-800 border border-gray-700 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
          </div>
        </div>

        <div class="mt-5 flex flex-wrap items-center gap-3">
          <button
            id="joinBtn"
            class="inline-flex items-center justify-center rounded-md bg-indigo-600 hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500 px-4 py-2 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Join and Start Streaming
          </button>
          <button
            id="leaveBtn"
            class="inline-flex items-center justify-center rounded-md bg-gray-700 hover:bg-gray-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-gray-500 px-4 py-2 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Leave Stream
          </button>
          <button
            id="enableAudioBtn"
            class="inline-flex items-center justify-center rounded-md bg-pink-600 hover:bg-pink-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-pink-500 px-4 py-2 text-sm font-medium"
          >
            Enable Sounds
          </button>
          <button
            id="flipBtn"
            class="inline-flex items-center justify-center rounded-md bg-indigo-700 hover:bg-indigo-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 px-4 py-2 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Switch Device Camera
          </button>
          <span id="status" class="text-sm text-gray-400">Disconnected</span>
        </div>

        <div class="mt-6">
          <h2 class="text-lg font-semibold mb-2">Local Preview</h2>
          <div
            id="local-player"
            class="relative w-full aspect-video rounded-lg bg-black/60 border border-gray-800 overflow-hidden"
          ></div>
        </div>
      </section>

      <section class="mt-10 text-xs text-gray-500">
        <p>
          Tip: This page must be served over HTTPS for camera and microphone
          permissions to work in most browsers (GitHub Pages is HTTPS by default).
        </p>
      </section>
    </main>

    <script>
      // High-level variables that hold Agora client and local tracks
      /** @type {import('agora-rtc-sdk-ng').IAgoraRTCClient | null} */
      let client = null;
      /** @type {import('agora-rtc-sdk-ng').IMicrophoneAudioTrack | null} */
      let microphoneTrack = null;
      /** @type {import('agora-rtc-sdk-ng').ICameraVideoTrack | null} */
      let cameraTrack = null;
      let joined = false;

      const $ = (id) => document.getElementById(id);
      const joinBtn = $("joinBtn");
      const leaveBtn = $("leaveBtn");
      const statusEl = $("status");
      const enableAudioBtn = $("enableAudioBtn");
      const flipBtn = $("flipBtn");
      
      // RTM for receiving playSound commands
      /** @type {any} */
      let rtmClient = null;
      /** @type {any} */
      let rtmChannel = null;
      let rtmUid = null;

      // Simple sound library (placeholder). Replace sources as desired.
      const soundFiles = {
        meow: "./assets/cat-meow-8-fx-306184.mp3",
        treats: "./assets/excited-cat-meowing-anticipating-food-331462.mp3",
        pspsps: "./assets/cat-purring-261128.mp3",
        chirp: "./assets/bird-chirp-88706.mp3",
      };
      const soundElements = {};
      function getSoundEl(key) {
        if (!soundElements[key]) {
          const audio = new Audio(soundFiles[key]);
          audio.preload = "auto";
          soundElements[key] = audio;
        }
        return soundElements[key];
      }

      function setStatus(text) {
        statusEl.textContent = text;
      }

      function setUiWhileJoining() {
        joinBtn.disabled = true;
        leaveBtn.disabled = true;
        setStatus("Joiningâ€¦");
      }

      function setUiWhileStreaming() {
        joinBtn.disabled = true;
        leaveBtn.disabled = false;
        setStatus("Streaming Live");
      }

      function setUiWhileDisconnected() {
        joinBtn.disabled = false;
        leaveBtn.disabled = true;
        setStatus("Disconnected");
      }

      // Core: Initialize Agora client, join channel, create/publish local tracks
      async function joinAndPublish() {
        const appId = $("appId").value.trim();
        const tokenInput = $("token").value.trim();
        const channel = $("channel").value.trim();

        if (!appId || !channel) {
          alert("Please enter both App ID and Channel Name.");
          return;
        }

        if (joined) return;

        try {
          setUiWhileJoining();

          // 1) Initialize the client. We use the 'live' profile to support host/audience roles.
          client = AgoraRTC.createClient({ mode: "live", codec: "h264" });
          // Broadcasters are 'host'. This allows publishing.
          await client.setClientRole("host");

          // 2) Join the channel. If token is empty, pass null.
          const uid = await client.join(appId, channel, tokenInput || null, null);

          // 3) Create microphone and camera tracks.
          // This will prompt for permissions. If the user denies, it will throw.
          const [microphone, camera] = await AgoraRTC.createMicrophoneAndCameraTracks();
          microphoneTrack = microphone;
          cameraTrack = camera;

          // 4) Play local video so the streamer can see themselves.
          cameraTrack.play("local-player");

          // 5) Publish both audio and video tracks to the channel.
          await client.publish([microphoneTrack, cameraTrack]);

          joined = true;
          setUiWhileStreaming();
          console.log("Joined as UID:", uid);

          // Initialize RTM for receiving control messages
          try {
            rtmClient = AgoraRTM.createInstance(appId);
            rtmUid = String(uid);
            await rtmClient.login({ uid: rtmUid });
            rtmChannel = await rtmClient.createChannel(channel);
            await rtmChannel.join();
            // Handle peer messages
            rtmClient.on("MessageFromPeer", async (message, peerId) => {
              try {
                const payload = JSON.parse(message.text || "{}");
                if (payload.type === "playSound" && payload.key && soundFiles[payload.key]) {
                  const el = getSoundEl(payload.key);
                  // Some browsers require a user gesture; attempt to play silently with volume control if needed
                  el.currentTime = 0;
                  el.volume = 1.0;
                  await el.play();
                } else if (payload.type === "memo" && payload.data && payload.format) {
                  // Decode and play once, do not persist
                  const binary = atob(payload.data);
                  const bytes = new Uint8Array(binary.length);
                  for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                  const blob = new Blob([bytes], { type: payload.format });
                  const url = URL.createObjectURL(blob);
                  const memoAudio = new Audio(url);
                  memoAudio.volume = 1.0;
                  memoAudio.addEventListener("ended", () => URL.revokeObjectURL(url), { once: true });
                  try { await memoAudio.play(); } catch (e) { console.warn("Memo play failed:", e); }
                }
              } catch (e) {
                console.warn("Failed to handle RTM message:", e);
              }
            });
          } catch (e) {
            console.warn("RTM init failed:", e);
          }
        } catch (err) {
          console.error(err);
          alert("Failed to start streaming: " + (err && err.message ? err.message : err));
          await cleanup();
          setUiWhileDisconnected();
        }
      }

      // Core: Unpublish and leave the channel, cleaning up local resources
      async function leaveChannel() {
        if (!client) {
          setUiWhileDisconnected();
          return;
        }
        try {
          // Unpublish local tracks if present
          const tracks = [];
          if (microphoneTrack) tracks.push(microphoneTrack);
          if (cameraTrack) tracks.push(cameraTrack);
          if (tracks.length > 0) {
            await client.unpublish(tracks);
          }
        } catch (err) {
          console.warn("Unpublish warning:", err);
        } finally {
          await cleanup();
          try {
            await client.leave();
          } catch (err) {
            console.warn("Leave warning:", err);
          }
          try {
            if (rtmChannel) await rtmChannel.leave();
            if (rtmClient && rtmClient.logout) await rtmClient.logout();
          } catch (e) {}
          client = null;
          joined = false;
          setUiWhileDisconnected();
        }
      }

      async function cleanup() {
        try {
          if (cameraTrack) {
            cameraTrack.stop();
            cameraTrack.close();
            cameraTrack = null;
          }
          if (microphoneTrack) {
            microphoneTrack.stop();
            microphoneTrack.close();
            microphoneTrack = null;
          }
          // Clear local player area
          const local = document.getElementById("local-player");
          if (local) local.innerHTML = "";
        } catch (err) {
          console.warn("Cleanup warning:", err);
        }
      }

      // Prefill inputs with your defaults and allow URL overrides
      (function prefill() {
        const params = new URLSearchParams(window.location.search);
        const defaultAppId = "c36cae78aea74b38ae8706fcd9557387";
        const defaultChannel = "cat-cam";

        const appIdParam = params.get("appId");
        const channelParam = params.get("channel");
        const tokenParam = params.get("token");

        const appIdEl = $("appId");
        const channelEl = $("channel");
        const tokenEl = $("token");

        if (appIdEl && !appIdEl.value) appIdEl.value = appIdParam || defaultAppId;
        if (channelEl && !channelEl.value) channelEl.value = channelParam || defaultChannel;
        if (tokenEl && tokenParam) tokenEl.value = tokenParam;
      })();

      // Wire up UI events
      joinBtn.addEventListener("click", () => {
        joinAndPublish();
      });
      leaveBtn.addEventListener("click", () => {
        leaveChannel();
      });
      enableAudioBtn.addEventListener("click", async () => {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const buffer = ctx.createBuffer(1, 1, 22050);
          const source = ctx.createBufferSource();
          source.buffer = buffer;
          source.connect(ctx.destination);
          source.start(0);
        } catch (e) {}
      });

      async function getCurrentCameraDeviceId() {
        try {
          if (!cameraTrack) return null;
          const mediaTrack = cameraTrack.getMediaStreamTrack ? cameraTrack.getMediaStreamTrack() : null;
          if (mediaTrack && mediaTrack.getSettings) {
            const settings = mediaTrack.getSettings();
            return settings && settings.deviceId ? settings.deviceId : null;
          }
        } catch (_) {}
        return null;
      }

      async function flipCamera() {
        if (!cameraTrack) return;
        flipBtn.disabled = true;
        try {
          const cameras = await AgoraRTC.getCameras();
          if (!cameras || cameras.length < 2) {
            alert("Only one camera detected.");
            return;
          }
          let currentId = await getCurrentCameraDeviceId();
          let next = cameras[0];
          if (currentId) {
            const idx = cameras.findIndex((d) => d.deviceId === currentId);
            next = cameras[(idx + 1) % cameras.length];
          }
          await cameraTrack.setDevice(next.deviceId);
        } catch (err) {
          console.warn("Flip camera failed:", err);
        } finally {
          flipBtn.disabled = false;
        }
      }

      flipBtn.addEventListener("click", flipCamera);

      // Ensure resources are released if the page is closed/refreshed
      window.addEventListener("beforeunload", () => {
        if (joined) {
          // Fire and forget
          leaveChannel();
        }
      });
    </script>
  </body>
  </html>


